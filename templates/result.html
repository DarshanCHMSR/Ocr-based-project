{% extends "base.html" %}

{% block title %}Extraction Results - PDF & OCR Text Extractor{% endblock %}

{% block content %}
<!-- Results Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-file-text text-success"></i> Extraction Complete!</h4>
                    <p class="mb-0">File: <strong>{{ filename }}</strong></p>
                </div>
                <div class="text-end">
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Process Another File
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-font fa-2x text-primary mb-2"></i>
            <h5>{{ char_count }}</h5>
            <p class="text-muted mb-0">Characters</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-spell-check fa-2x text-success mb-2"></i>
            <h5>{{ word_count }}</h5>
            <p class="text-muted mb-0">Words</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-list-ol fa-2x text-warning mb-2"></i>
            <h5>{{ line_count }}</h5>
            <p class="text-muted mb-0">Lines</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-clock fa-2x text-info mb-2"></i>
            <h5 id="readingTime">-</h5>
            <p class="text-muted mb-0">Min Read</p>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                <button class="btn btn-custom" onclick="saveEditedText()">
                    <i class="fas fa-save"></i> Save Edited Text
                </button>
                {% if output_file %}
                <a href="/download/{{ output_file }}" class="btn btn-outline-success">
                    <i class="fas fa-download"></i> Download Original
                </a>
                {% endif %}
                <button class="btn btn-outline-info" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copy Text
                </button>
                <button class="btn btn-outline-warning" onclick="clearEditor()">
                    <i class="fas fa-eraser"></i> Clear Editor
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i> Fullscreen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quill Editor -->
<div class="row">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-edit"></i> Edit Extracted Text</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                        <i class="fas fa-underline"></i>
                    </button>
                </div>
            </div>
            
            <!-- Quill Editor Container -->
            <div id="editor-container">
                <div id="editor" style="min-height: 400px;">
                    {{ text|safe }}
                </div>
            </div>
            
            <!-- Word Count Display -->
            <div class="mt-3 d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Use the toolbar above to format your text. Changes are automatically tracked.
                </small>
                <div class="text-muted">
                    <span id="editorWordCount">{{ word_count }}</span> words | 
                    <span id="editorCharCount">{{ char_count }}</span> characters
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Status -->
<div id="saveStatus" class="mt-3" style="display: none;">
    <div class="alert alert-success alert-custom">
        <i class="fas fa-check-circle"></i> <span id="saveMessage"></span>
        <a id="downloadLink" href="#" class="btn btn-sm btn-outline-success ms-2" style="display: none;">
            <i class="fas fa-download"></i> Download
        </a>
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="modal fade" id="fullscreenModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Fullscreen Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="fullscreen-editor" style="height: calc(100vh - 120px);"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-custom" onclick="saveFromFullscreen()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .ql-editor {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 16px;
        line-height: 1.6;
    }
    
    .ql-toolbar.ql-snow {
        border-top: 1px solid #ccc;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .ql-container.ql-snow {
        border-bottom: 1px solid #ccc;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    .fullscreen-editor .ql-editor {
        min-height: calc(100vh - 200px) !important;
    }
    
    @media (max-width: 768px) {
        .d-flex.gap-2 {
            flex-direction: column;
        }
        
        .d-flex.gap-2 > * {
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let quill;
let fullscreenQuill;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'blockquote', 'code-block'],
                ['clean']
            ]
        },
        placeholder: 'Start editing your extracted text...'
    });
    
    // Update word count on text change
    quill.on('text-change', function() {
        updateWordCount();
    });
    
    // Calculate reading time
    calculateReadingTime();
    
    // Initial word count update
    updateWordCount();
});

function updateWordCount() {
    const text = quill.getText();
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    const charCount = text.length;
    
    document.getElementById('editorWordCount').textContent = wordCount;
    document.getElementById('editorCharCount').textContent = charCount;
}

function calculateReadingTime() {
    const wordsPerMinute = 200;
    const wordCount = {{ word_count }};
    const readingTime = Math.ceil(wordCount / wordsPerMinute);
    document.getElementById('readingTime').textContent = readingTime;
}

function saveEditedText() {
    const text = quill.getText();
    const htmlContent = quill.root.innerHTML;
    
    if (!text.trim()) {
        alert('Editor is empty. Nothing to save.');
        return;
    }
    
    // Show loading state
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    fetch('/save_edited', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            html: htmlContent,
            filename: '{{ filename }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSaveStatus(data.message, data.filename);
        } else {
            alert('Error saving file: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving file. Please try again.');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function showSaveStatus(message, filename) {
    const statusDiv = document.getElementById('saveStatus');
    const messageSpan = document.getElementById('saveMessage');
    const downloadLink = document.getElementById('downloadLink');
    
    messageSpan.textContent = message;
    
    if (filename) {
        downloadLink.href = '/download/' + filename;
        downloadLink.style.display = 'inline-block';
    }
    
    statusDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function copyToClipboard() {
    const text = quill.getText();
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-info');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-info');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy text to clipboard');
    });
}

function clearEditor() {
    if (confirm('Are you sure you want to clear all text? This action cannot be undone.')) {
        quill.setText('');
        updateWordCount();
    }
}

function toggleFullscreen() {
    const modal = new bootstrap.Modal(document.getElementById('fullscreenModal'));
    
    // Initialize fullscreen editor if not already done
    if (!fullscreenQuill) {
        fullscreenQuill = new Quill('#fullscreen-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'blockquote', 'code-block'],
                    ['clean']
                ]
            }
        });
    }
    
    // Copy content to fullscreen editor
    fullscreenQuill.setContents(quill.getContents());
    
    modal.show();
}

function saveFromFullscreen() {
    // Copy content back to main editor
    quill.setContents(fullscreenQuill.getContents());
    updateWordCount();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('fullscreenModal'));
    modal.hide();
    
    // Show success message
    alert('Changes copied to main editor successfully!');
}

function formatText(format) {
    const selection = quill.getSelection();
    if (selection) {
        quill.format(format, true);
    } else {
        alert('Please select text to format');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                saveEditedText();
                break;
            case 'f':
                e.preventDefault();
                toggleFullscreen();
                break;
        }
    }
});
</script>
{% endblock %}
