{% extends "base.html" %}

{% block title %}ಎಕ್ಸ್ಟ್ರ್ಯಾಕ್ಷನ್ ಫಲಿತಾಂಶಗಳು - PDF ಮತ್ತು OCR ಪಠ್ಯ ಎಕ್ಸ್ಟ್ರಾಕ್ಟರ್{% endblock %}

{% block content %}
<!-- Results Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-file-text text-success"></i> ಎಕ್ಸ್ಟ್ರ್ಯಾಕ್ಷನ್ ಸಿದ್ಧವಾಗಿದೆ!</h4>
                    <p class="mb-0">ಫೈಲ್: <strong>{{ filename }}</strong></p>
                </div>
                <div class="text-end">
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> ಮತ್ತೊಂದು ಫೈಲ್ ಪ್ರಕ್ರಿಯೆ ಮಾಡಿ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-font fa-2x text-primary mb-2"></i>
            <h5>{{ char_count }}</h5>
            <p class="text-muted mb-0">ಅಕ್ಷರಗಳು</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-spell-check fa-2x text-success mb-2"></i>
            <h5>{{ word_count }}</h5>
            <p class="text-muted mb-0">ಪದಗಳು</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-list-ol fa-2x text-warning mb-2"></i>
            <h5>{{ line_count }}</h5>
            <p class="text-muted mb-0">ರೆಖೆಗಳು</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="feature-card text-center">
            <i class="fas fa-clock fa-2x text-info mb-2"></i>
            <h5 id="readingTime">-</h5>
            <p class="text-muted mb-0">ಓದಲು (ನಿಮಿಷ)</p>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                <button class="btn btn-custom" onclick="saveEditedText(event)">
                    <i class="fas fa-save"></i> ಸಂಪಾದಿಸಿದ ಪಠ್ಯ ಉಳಿಸಿ
                </button>
                {% if output_file %}
                <a href="/download/{{ output_file }}" class="btn btn-outline-success">
                    <i class="fas fa-download"></i> ಮೂಲವನ್ನು ಡೌನ್‌ಲೋಡ್ ಮಾಡಿ
                </a>
                {% endif %}
                <button class="btn btn-outline-info" onclick="copyToClipboard(event)">
                    <i class="fas fa-copy"></i> ಪಠ್ಯ ನಕಲಿಸು
                </button>
                <button class="btn btn-outline-warning" onclick="clearEditor()">
                    <i class="fas fa-eraser"></i> ಸಂಪಾದಕ ತೆರವುಗೊಳಿಸಿ
                </button>
                <!-- fullscreen removed -->
            </div>
        </div>
    </div>
</div>

<!-- Quill Editor -->
<div class="row">
    <div class="col-12">
        <div class="feature-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-edit"></i> ತೆಗಿದ ಪಠ್ಯವನ್ನು ಸಂಪಾದಿಸಿ</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                        <i class="fas fa-underline"></i>
                    </button>
                </div>
            </div>
            
            <!-- Quill Editor Container -->
            <div id="editor-container">
                <div id="editor" class="editor" style="min-height: 400px;">
                    {{ text|safe }}
                </div>
            </div>
            
            <!-- Word Count Display -->
            <div class="mt-3 d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    ಮೇಲಿನ ಟೂಲ್ಬಾರ್‌ನ್ನು ಬಳಸುತ್ತಾ ನಿಮ್ಮ ಪಠ್ಯವನ್ನು ಸ್ವರೂಪಗೊಳಿಸಿ. ಬದಲಾವಣೆಗಳನ್ನು ಸ್ವಯಂಚಾಲಿತವಾಗಿ ಟ್ರ್ಯಾಕ್ ಮಾಡಲಾಗುತ್ತದೆ.
                </small>
                <div class="text-muted">
                    <span id="editorWordCount">{{ word_count }}</span> ಪದಗಳು | 
                    <span id="editorCharCount">{{ char_count }}</span> ಅಕ್ಷರಗಳು
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Status -->
<div id="saveStatus" class="mt-3" style="display: none;">
    <div class="alert alert-success alert-custom">
        <i class="fas fa-check-circle"></i> <span id="saveMessage"></span>
        <a id="downloadLink" href="#" class="btn btn-sm btn-outline-success ms-2" style="display: none;">
            <i class="fas fa-download"></i> ಡೌನ್‌ಲೋಡ್
        </a>
    </div>
</div>

<!-- Fullscreen feature removed -->

<!-- Creator credit -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <small>Created by <a href="https://github.com/DarshanCHMSR" target="_blank" rel="noopener noreferrer">DarshanCHMSR</a></small>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .ql-editor {
        font-family: 'Noto Sans Kannada', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 16px;
        line-height: 1.6;
    }

    /* Explicit editor class to ensure Kannada-friendly font */
    .editor {
        font-family: 'Noto Sans Kannada', sans-serif;
    }
    
    .ql-toolbar.ql-snow {
        border-top: 1px solid #ccc;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .ql-container.ql-snow {
        border-bottom: 1px solid #ccc;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    /* fullscreen editor removed */
    
    @media (max-width: 768px) {
        .d-flex.gap-2 {
            flex-direction: column;
        }
        
        .d-flex.gap-2 > * {
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let quill;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'blockquote', 'code-block'],
                ['clean']
            ]
        },
        placeholder: 'ತೆಗಿದ ಪಠ್ಯವನ್ನು ಸಂಪಾದನೆ ಪ್ರಾರಂಭಿಸಿ...'
    });
    
    // Update word count on text change and run offline transliteration for user input
    quill.on('text-change', function(delta, oldDelta, source) {
        // Only respond to user typing (not api inserts)
        if (source === 'user') {
            // run transliteration fallback asynchronously
            runOfflineTransliterationIfNeeded().catch(err => console.warn('Transliteration fallback error:', err));
        }
        updateWordCount();
    });
    
    // Ensure editor is enabled and focused for editing
    try {
        quill.enable(true);
        quill.focus();
    } catch (e) {
        console.warn('Quill focus/enable failed:', e);
    }
    
    // Calculate reading time
    calculateReadingTime();
    
    // Initial word count update
    updateWordCount();
});

function updateWordCount() {
    const text = quill.getText();
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    const charCount = text.length;
    
    document.getElementById('editorWordCount').textContent = wordCount;
    document.getElementById('editorCharCount').textContent = charCount;
}

function calculateReadingTime() {
    const wordsPerMinute = 200;
    const wordCount = {{ word_count }};
    const readingTime = Math.ceil(wordCount / wordsPerMinute);
    document.getElementById('readingTime').textContent = readingTime;
}

function saveEditedText(evt) {
    const text = quill.getText();
    const htmlContent = quill.root.innerHTML;
    
    if (!text.trim()) {
        alert('ಸಂಪಾದಕ ಖಾಲಿದಾಗಿದೆ. ಉಳಿಸಲು ಏನೂ ಇಲ್ಲ.');
        return;
    }
    
    // Show loading state (guard event)
    let saveBtn = null;
    let originalText = null;
    if (evt && evt.target) {
        saveBtn = evt.target;
        // If the button contains inner elements (icon), climb to button
        if (saveBtn.tagName !== 'BUTTON') saveBtn = saveBtn.closest('button') || saveBtn;
        if (saveBtn) {
            originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ಉಳಿಸಲಾಗುತ್ತಿದೆ...';
            saveBtn.disabled = true;
        }
    }
    
    fetch('/save_edited', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            html: htmlContent,
            filename: '{{ filename }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSaveStatus(data.message, data.filename);
        } else {
            alert('ಫೈಲ್ ಉಳಿಸಲು ದೋಷ: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
            alert('ಫೈಲ್ ಉಳಿಸುವಲ್ಲಿ ದೋಷವಾಗಿದೆ. ದಯವಿಟ್ಟು ಮರುಪ್ರಯತ್ನಿಸಿ.');
    })
    .finally(() => {
        if (saveBtn) {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    });
}

function showSaveStatus(message, filename) {
    const statusDiv = document.getElementById('saveStatus');
    const messageSpan = document.getElementById('saveMessage');
    const downloadLink = document.getElementById('downloadLink');
    
    messageSpan.textContent = message;
    
    if (filename) {
        downloadLink.href = '/download/' + filename;
        downloadLink.style.display = 'inline-block';
    }
    
    statusDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function copyToClipboard(evt) {
    const text = quill.getText();
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        if (evt && evt.target) {
            let btn = evt.target;
            if (btn.tagName !== 'BUTTON') btn = btn.closest('button') || btn;
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> ನಕಲಿಸಲಾಗಿದೆ!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-info');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-info');
                }, 2000);
            }
        }
    }).catch(err => {
        alert('ಕ್ಲಿಪ್‌ಬೋರ್ಡಿಗೆ ಪಠ್ಯ ನಕಲಿಸಲು ವಿಫಲವಾಗಿದೆ');
    });
}

function clearEditor() {
    if (confirm('ನೀವು ಎಲ್ಲಾ ಪಠ್ಯವನ್ನು ತೆರವುಗೊಳಿಸುವ ಬಗ್ಗೆ ಖಚಿತವಾ? ಈ ಕಾರ್ಯವನ್ನು ಮರಳಿಸಲು ಸಾಧ್ಯವಿಲ್ಲ.')) {
        quill.setText('');
        updateWordCount();
    }
}

/* Fullscreen removed */

function formatText(format) {
    const selection = quill.getSelection();
    if (selection) {
        quill.format(format, true);
    } else {
    alert('ದಯವಿಟ್ಟು ಸ್ವರೂಪಗೊಳಿಸಲು ಪಠ್ಯವನ್ನು ಆಯ್ಕೆಮಾಡಿ');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                saveEditedText();
                break;
            // fullscreen shortcut removed
        }
    }
});

// Initialize Google Input Tools Transliteration (polling until API is available)
function initGoogleTransliteration() {
    let attempts = 0;
    const maxAttempts = 30; // ~9 seconds
    const interval = 300;
    let attemptedJsapiLoad = false; // try loading 'elements' package one time if possible

    const timer = setInterval(() => {
        attempts += 1;
        // If the transliteration runtime is already present, initialize
        if (window.google && google.elements && google.elements.transliteration) {
            clearInterval(timer);
            try {
                const options = {
                    sourceLanguage: google.elements.transliteration.LanguageCode.ENGLISH,
                    destinationLanguage: [google.elements.transliteration.LanguageCode.KANNADA],
                    transliterationEnabled: true
                };
                const control = new google.elements.transliteration.TransliterationControl(options);
                // Attach to Quill's editable element (id 'editor')
                control.makeTransliteratable(['editor']);
                control.setShortcutKey('ctrl+g');
                console.info('Google Transliteration initialized for Kannada on #editor');
            } catch (err) {
                console.warn('Failed to initialize TransliterationControl:', err);
            }
        } else if (window.google && typeof google.load === 'function' && !attemptedJsapiLoad) {
            // Avoid calling deprecated/unsupported modules via google.load; just note availability
            attemptedJsapiLoad = true;
            console.info('google.load detected but skipping one-time elements.load to avoid unsupported module errors.');
        } else if (attempts >= maxAttempts) {
            clearInterval(timer);
            console.info('Transliteration API not available after waiting; falling back to offline/server transliteration.');
        }
    }, interval);
}

// Kick off transliteration init after DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    initGoogleTransliteration();
});

// NOTE: We attempt a one-time jsapi load from inside the polling initializer above
// to avoid repeatedly calling deprecated/unsupported modules like 'inputtools'.
// If Google Transliteration is not available in the user's network, you may add a server-side fallback.

// NOTE: duplicate handlers were removed — transliteration is triggered
// from the safer DOMContentLoaded initialization above where `quill` is defined.
</script>
{% endblock %}
